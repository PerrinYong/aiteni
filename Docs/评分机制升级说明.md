# NTRP评分机制升级说明

## 已实现的两大新机制

### 一、高段位锚点(Anchor)机制

#### 功能说明
区分三种不同类型的选项,实现更精准的评分:

1. **普通选项(normal)** - 默认类型
   - 使用高斯分布计算隶属度
   - 适用于一般性描述选项

2. **定位选项(locator)** - 用于定位档位
   - 使用更窄的高斯分布(σ=0.5)
   - 对中心等级附近提供强烈支持
   - 权重加成系数1.2
   - 示例: Q1_A3(3.0档位), Q5_A4(3.5档位)

3. **基线选项(baseline)** - 判断高段位门槛
   - 只对≥baseline_min_level的等级提供支持
   - 下位截断,确保4.5+选手必备能力
   - 示例: Q1_A6(4.5门槛), Q5_A6(4.5门槛), Q11_A5(4.5门槛)

#### 配置示例
```json
{
  "id": "Q1_A6",
  "text": "在接近比赛节奏的多拍对拉中，失误率较低，能主动控制回合节奏",
  "center_level": 4.5,
  "anchor_type": "baseline",
  "baseline_min_level": 4.5
}
```

#### 数学原理

**定位选项隶属度**:
```
m(L) = exp(-(L - c)² / (2 * 0.5²))
```

**基线选项隶属度**:
```
m(L) = 0,                               if L < L_min
       exp(-(L - L_min)² / (2 * 1.0²)), if L ≥ L_min
```

### 二、木桶效应(维度均衡度校准)

#### 功能说明
通过技术全面性指标调整总体评级:
- 高水平且均衡 → 正向加成
- 不均衡(有明显短板) → 向短板拉低

#### 关键指标

1. **维度方差(σ²)** - 衡量技术不均衡程度
   ```
   σ² = (1/N) Σ(D_d - μ)²
   ```

2. **均衡度因子(B)** - 范围[0,1]
   ```
   B = clip(1 - (σ² - 0.1) / (1.0 - 0.1), 0, 1)
   ```
   - B → 1: 技术很均衡
   - B → 0: 技术极不均衡

3. **木桶修正等级**
   ```
   L_barrel = B × L_base + (1 - B) × D_min
   ```
   - 均衡时接近基础等级
   - 不均衡时被拉向短板

4. **全面型加成**
   - 条件: 平均≥4.5 且 均衡度≥0.8
   - 加成: +0.25级

#### 常量配置

```python
VARIANCE_LOW = 0.1        # 基本均衡阈值
VARIANCE_HIGH = 1.0       # 严重不均衡阈值
BALANCE_THRESHOLD = 0.8   # 高均衡度阈值
HIGH_LEVEL_THRESHOLD = 4.5 # 高水平阈值
MAX_BARREL_PENALTY = 1.0  # 最大下调幅度
COMPREHENSIVE_BONUS = 0.25 # 全面型加成
```

## 评分流程

```
1. 问卷答题
   ↓
2. Anchor机制计算支持度分布
   - normal选项: 标准高斯
   - locator选项: 窄高斯 + 权重加成
   - baseline选项: 下位截断
   ↓
3. 计算基础等级(L_base)
   ↓
4. 计算维度统计
   - 平均值μ
   - 方差σ²
   - 最小值D_min
   ↓
5. 计算均衡度因子B
   ↓
6. 木桶效应调整
   - L_barrel = B×L_base + (1-B)×D_min
   - 应用最大下调限制
   ↓
7. 高水平全面型加成(可选)
   - 若μ≥4.5 且 B≥0.8: +0.25
   ↓
8. 最终等级 → 四舍五入到0.5档
```

## 使用示例

### 配置文件更新
在`questions.json`中为关键选项添加`anchor_type`:

```json
{
  "id": "Q1",
  "options": [
    {
      "id": "Q1_A3",
      "center_level": 3.0,
      "anchor_type": "locator"
    },
    {
      "id": "Q1_A6",
      "center_level": 4.5,
      "anchor_type": "baseline",
      "baseline_min_level": 4.5
    }
  ]
}
```

### 测试脚本
运行测试脚本查看新机制效果:
```bash
python test_new_mechanisms.py
```

## 预期效果

### Anchor机制
- 定位选项使评分更集中在目标档位
- 基线选项防止虚高评分,确保高段位门槛

### 木桶效应
- **均衡选手**(方差0.1, B=1.0): 不降级
- **轻度不均衡**(方差0.5, B≈0.5): 略降0.2-0.4级
- **严重不均衡**(方差1.0, B=0): 降至接近短板

### 示例对比

**场景1: 高水平均衡选手**
- 各维度: 4.5-5.0
- 方差: 0.08
- 均衡度: 1.0
- 结果: 基础等级4.7 + 加成0.25 = 4.95 → **5.0**

**场景2: 高水平不均衡选手**
- 正手: 5.0, 反手: 3.0, 其他: 4.0-4.5
- 方差: 0.45
- 均衡度: 0.61
- 短板: 3.0
- 结果: 0.61×4.5 + 0.39×3.0 = 3.91 → **4.0**

## 文件变更清单

### 核心代码
- `src/data_models.py`: 扩展OptionConfig和EvaluateResult
- `src/ntrp_evaluator.py`: 实现Anchor和木桶效应
- `src/config_manager.py`: 支持加载新字段

### 配置文件
- `config/questions.json`: 为Q1/Q5/Q11添加anchor_type

### 测试文件
- `test_new_mechanisms.py`: 验证新机制

## 参数调优建议

### Anchor机制
- `LOCATOR_SIGMA`: 0.5(可调整0.3-0.8)
- `BASELINE_SIGMA`: 1.0(可调整0.8-1.5)
- `LOCATOR_BOOST`: 1.2(可调整1.0-1.5)

### 木桶效应
- `VARIANCE_LOW`: 0.1(方差小于此值视为均衡)
- `VARIANCE_HIGH`: 1.0(方差大于此值视为极不均衡)
- `BALANCE_THRESHOLD`: 0.8(均衡度高于此值可获得加成)
- `MAX_BARREL_PENALTY`: 1.0(最多下调1个等级)
- `COMPREHENSIVE_BONUS`: 0.25(全面型加成)

## 后续优化方向

1. **数据驱动的参数优化**
   - 收集真实用户数据
   - 统计分析最优参数

2. **更细粒度的baseline设置**
   - 5.0门槛选项
   - 5.5门槛选项

3. **维度权重动态调整**
   - 根据比赛表现加权
   - 核心技术(底线/发球)权重更高

4. **可视化增强**
   - 显示均衡度雷达图
   - 木桶效应影响说明
